on: pull_request

name: deploy preview

jobs:
  deploy_preview:
    name: Deploy preview
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - uses: cachix/install-nix-action@v18
      - uses: cachix/cachix-action@v12
        with:
          name: coord-e-com
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      - run: nix-build
      # We need to move files in order to allow access via docker's volume mount
      - run: |
          mkdir dist
          cp -r result/* dist/
      - id: deploy_to_netlify
        uses: netlify/actions/cli@6c34c3fcafc69ac2e1d6dbf226560329c6dfc51b
        with:
          args: deploy --dir=dist
        env:
          NETLIFY_SITE_ID: '${{ secrets.NETLIFY_SITE_ID }}'
          NETLIFY_AUTH_TOKEN: '${{ secrets.NETLIFY_AUTH_TOKEN }}'
      - uses: actions/github-script@v6
        env:
          NETLIFY_URL: '${{ steps.deploy_to_netlify.outputs.NETLIFY_URL }}'
          NETLIFY_OUTPUT: '${{ steps.deploy_to_netlify.outputs.NETLIFY_OUTPUT }}'
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [
                  `Deploy preview ready: ${process.env.NETLIFY_URL}`,
                  '<details>',
                  '',
                  '```',
                  process.env.NETLIFY_OUTPUT,
                  '```',
                  '</details>'
                ].join('\n')
            })
